<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Alias CBU ‚Äì Gasless AIC</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 840px; margin: 2rem auto; padding: 0 1rem; background: #fafafa; }
    label { display:block; margin-top: 1rem; font-weight: 600; }
    input, button { padding: .6rem .8rem; font-size: 1rem; }
    button { cursor:pointer; border-radius: 6px; border: 1px solid #ccc; background: white; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 0.9em; }
    .card { border:1px solid #ddd; border-radius: 10px; padding: 1rem; margin-top:1rem; background: white; }
    .ok { color:#0a0; font-weight: 600; } 
    .err { color:#a00; font-weight: 600; } 
    .warn { color:#f80; font-weight: 600; }
    .muted { color:#666; font-size:.9rem }
    .alert { background: #fff3cd; border: 1px solid #ffc107; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
    .alert-danger { background: #f8d7da; border-color: #f5c6cb; }
    pre { background: #f5f5f5; padding: 0.5rem; border-radius: 4px; overflow-x: auto; }
    #wallet-ok { margin-top: .5rem; color: #086; font-weight: 600; }
    #wallet-error { margin-top: .5rem; color: #c00; }
  </style>
</head>
<body>
  <h1>Registrar alias (gasless, paga en AIC)</h1>
  
  <div class="alert alert-danger">
    <strong>üî¥ ERROR React #310 - Es un BUG de la extensi√≥n</strong><br/><br/>
    <strong>SOLUCIONES que funcionan:</strong><br/>
    1. ‚úÖ <strong>Usar FIREFOX</strong> (la extensi√≥n funciona mejor ah√≠)<br/>
    2. ‚úÖ Actualizar ArgentX/Braavos a la √∫ltima versi√≥n<br/>
    3. ‚úÖ Probar en otro navegador (Brave, Edge)<br/>
    4. ‚ùå NO es un problema de este c√≥digo<br/><br/>
    <a href="https://github.com/argentlabs/argent-x/issues" target="_blank" style="color: #0066cc;">
      ‚Üí Ver issues conocidos de ArgentX
    </a>
  </div>

  <p class="muted">
    1) Conect√° wallet ¬∑ 2) Prepar√° ¬∑ 3) Approve AIC ¬∑ 4) Firmar ¬∑ 5) Enviar<br/>
    <small>Si el approve falla, us√° Firefox o actualiz√° la extensi√≥n.</small>
  </p>

  <div class="card">
    <div class="row">
      <button id="btn-connect">Conectar Wallet</button>
      <button id="btn-reset" type="button">Reset</button>
      <span id="acc" class="mono"></span>
    </div>

    <label for="alias">Alias (a-z 0-9 .) 4‚Äì20</label>
    <input id="alias" placeholder="mi.alias" style="width:100%; font-family: monospace;"/>

    <div class="row" style="margin-top: .5rem;">
      <button id="btn-prepare" disabled>1. Preparar</button>
      <button id="btn-approve" disabled>2. Approve AIC</button>
      <button id="btn-sign" disabled>3. Firmar</button>
      <button id="btn-submit" disabled>4. Enviar</button>
    </div>

    <div id="prep" class="mono" style="white-space:pre-wrap; margin-top:1rem; font-size: 0.85em;"></div>
    <div id="out" style="margin-top:1rem;"></div>
  </div>

  <div class="card">
    <h3>Buscar / Resolver</h3>
    <div class="row">
      <input id="q-alias" placeholder="alias (p.ej. pepe.123)" style="flex:1; font-family:monospace;">
      <button id="btn-resolve-alias">Alias ‚Üí Address</button>
    </div>
    <div class="row" style="margin-top:.5rem;">
      <input id="q-addr" placeholder="0x..." style="flex:1; font-family:monospace;">
      <button id="btn-resolve-addr">Address ‚Üí Alias</button>
    </div>
    <div class="row" style="margin-top:.5rem;">
      <button id="btn-list">Listar (√≠ndice local del relayer)</button>
    </div>
    <pre id="resolve-out" class="mono" style="margin-top: .5rem;"></pre>
  </div>

  <div id="wallet-ok"></div>
  <div id="wallet-error"></div>

  <!-- CONFIG: Si no ten√©s backend en este deploy, dej√° API_BASE = "" -->
  <script>
    const API_BASE = ""; // <-- PON√â la URL completa de tu backend si existe, p.ej "https://mi-relayer.example.com"
  </script>

  <script>
  (function () {
    const $ = id => document.getElementById(id);
    const okEl = $("wallet-ok");
    const errEl = $("wallet-error");

    function shortHex(h) {
      if (!h) return "";
      const s = h.replace(/^0x/, "");
      return "0x" + s.slice(0, 6) + "‚Ä¶" + s.slice(-6);
    }

    function showError(msg, noAlert=false) {
      console.error(msg);
      if (errEl) errEl.textContent = msg;
      if (!noAlert) alert(msg);
    }

    function log(m, type = 'info') {
      const icons = { info: '‚ÑπÔ∏è', ok: '‚úÖ', err: '‚ùå', warn: '‚ö†Ô∏è' };
      const classes = { info: '', ok: 'ok', err: 'err', warn: 'warn' };
      console.log("[aliascbu]", m);
      const html = `<span class="${classes[type]}">${icons[type]} ${
        typeof m === "string" ? m.replace(/\n/g, '<br/>') : JSON.stringify(m, null, 2)
      }</span>`;
      $("out").innerHTML = html;
    }

    // Utilities
    const FIELD_P = (2n ** 251n) + (17n * (2n ** 192n)) + 1n;
    const strip0x = (h) => (h || "").toLowerCase().replace(/^0x/, "");
    const padHex64 = (h) => "0x" + strip0x(h).padStart(64, "0");
    const toFeltHex = (hex) => {
      let n = BigInt("0x" + strip0x(hex));
      n = ((n % FIELD_P) + FIELD_P) % FIELD_P;
      return "0x" + n.toString(16);
    };
    const toUint256 = (value) => {
      const bn = BigInt(value);
      return {
        low: "0x" + (bn & ((1n << 128n) - 1n)).toString(16),
        high: "0x" + (bn >> 128n).toString(16)
      };
    };

    // typed data builder (compatible con tu backend)
    function buildTypedData(alias_key_hex, len, user_hex, nonce, chainId_hex) {
      const cleanHex = (h) => {
        const s = strip0x(h);
        return "0x" + (s.replace(/^0+/, "") || "0");
      };

      return {
        types: {
          StarkNetDomain: [
            { name: "name", type: "felt" },
            { name: "version", type: "felt" },
            { name: "chainId", type: "felt" },
          ],
          RegisterAlias: [
            { name: "user_addr", type: "felt" },
            { name: "alias_key", type: "felt" },
            { name: "len", type: "felt" },
            { name: "nonce", type: "felt" },
          ],
        },
        primaryType: "RegisterAlias",
        domain: {
          name: "AliasCBU",
          version: "1",
          chainId: cleanHex(chainId_hex),
        },
        message: {
          user_addr: toFeltHex(user_hex),
          alias_key: toFeltHex(alias_key_hex),
          len: String(len),
          nonce: String(nonce),
        },
      };
    }

    // Wait for wallet injection (manual connect flow uses this)
    function waitForWallets(ms = 8000) {
      return new Promise((resolve) => {
        const start = Date.now();

        function kick() {
          const sn = window.starknet || null;
          const argentx = (sn && sn.isArgentX) ? sn : (window.starknet_argentX || null);
          const braavos = (sn && sn.isBraavos) ? sn : (window.starknet_braavos || window.braavos || null);

          resolve({ braavos, argentx });
        }

        // if already present
        if (window.starknet || window.starknet_braavos || window.braavos || window.starknet_argentX) {
          return kick();
        }

        // listen for standard event
        window.addEventListener('starknet#initialized', () => kick(), { once: true });

        // fallback timeout
        setTimeout(kick, ms);
      });
    }

    // Attempt to connect by trying known providers
    async function connectDirect() {
      const { braavos, argentx } = await waitForWallets(8000);

      const candidates = [
        { name: 'ArgentX', obj: argentx },
        { name: 'Braavos', obj: braavos },
        { name: 'Braavos (legacy)', obj: window.braavos }
      ];

      for (const { name, obj } of candidates) {
        if (!obj) continue;
        try {
          if (typeof obj.enable === 'function') {
            await obj.enable({ starknetVersion: 'v5' });
          } else if (obj.request) {
            // some wallets expose other request shapes
            await obj.request({ type: 'wallet_requestAccounts' });
          }

          const acc = obj.account || obj.selectedAccount || obj;
          if (acc?.address) {
            return { account: acc, address: acc.address, name };
          }

          // fallback: some wallets set selectedAddress
          if (obj.selectedAddress) return { account: obj, address: obj.selectedAddress, name };
        } catch (e) {
          console.warn(`${name} fall√≥:`, e?.message || e);
        }
      }

      throw new Error("No se encontr√≥ Braavos ni ArgentX. Revis√° 'Site access' en la extensi√≥n y recarg√°.");
    }

    // DOM wiring & logic
    let account = null, userAddr = null, prepared = null, cfg = null;

    function enableButtons(p, a, s, su) {
      $("btn-prepare").disabled = !p;
      $("btn-approve").disabled = !a;
      $("btn-sign").disabled = !s;
      $("btn-submit").disabled = !su;
    }

    async function getJSON(url) {
      const r = await fetch(url);
      const t = await r.text();
      let d = null;
      try { d = t ? JSON.parse(t) : null; } catch {}
      if (!r.ok) throw new Error(d?.detail || d?.error || t || `HTTP ${r.status}`);
      return d ?? {};
    }

    // BUTTON: Connect
    $("btn-connect").onclick = async () => {
      try {
        log("Conectando wallet...");
        const conn = await connectDirect();
        account = conn.account;
        userAddr = padHex64(conn.address);
        $("acc").textContent = `${userAddr.slice(0,10)}...${userAddr.slice(-8)} (${conn.name})`;

        if (!API_BASE) {
          log("Conectado, pero API_BASE no configurado. Para usar prepare/submit necesit√°s un backend.", "warn");
          okEl && (okEl.textContent = `Conectado: ${shortHex(userAddr)} (${conn.name}). Backend no configurado.`);
          // Enable only prepare if you want to allow local-only flows; here we require backend
          enableButtons(false, false, false, false);
          return;
        }

        // fetch config from backend
        log("Obteniendo configuraci√≥n desde backend...", "info");
        const res = await fetch(`${API_BASE}/api/config`);
        if (!res.ok) throw new Error(await res.text());
        cfg = await res.json();

        cfg.aic_token = padHex64(cfg.aic_token);
        cfg.relayer_address = padHex64(cfg.relayer_address);
        cfg.chain_id = "0x" + strip0x(cfg.chain_id).replace(/^0+/, '');
        log(`Conectado: ${conn.name}\nChainId: ${cfg.chain_id}`, 'ok');
        okEl && (okEl.textContent = `Conectado: ${shortHex(userAddr)} (${conn.name})`);
        enableButtons(true, false, false, false);
      } catch (e) {
        log(`Error: ${e.message}\n\nProb√°:\n‚Ä¢ Recargar (Ctrl+Shift+R)\n‚Ä¢ Usar Firefox\n‚Ä¢ Actualizar extensi√≥n`, 'err');
        showError(e.message, true);
      }
    };

    // BUTTON: Reset
    $("btn-reset").onclick = () => {
      account = userAddr = prepared = cfg = null;
      $("acc").textContent = "";
      $("prep").textContent = "";
      enableButtons(false, false, false, false);
      $("resolve-out").textContent = "";
      $("out").innerHTML = "";
      okEl && (okEl.textContent = "");
      errEl && (errEl.textContent = "");
      log("Reset OK");
    };

    // BUTTON: Prepare
    $("btn-prepare").onclick = async () => {
      if (!userAddr) { alert("Conect√° wallet"); return; }
      const alias = $("alias").value.trim();
      if (!alias) { alert("Ingres√° un alias"); return; }
      if (!API_BASE) { showError("Backend no configurado (API_BASE vac√≠o). No puedo preparar.", true); return; }

      try {
        const res = await fetch(`${API_BASE}/api/prepare`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_address: userAddr, alias })
        });
        if (!res.ok) throw new Error(await res.text());
        prepared = await res.json();
        $("prep").textContent = `‚úì Alias: ${alias}\n  Key: ${prepared.alias_key}\n  Fee: ${prepared.fee_aic_wei} wei`;
        log("Preparado OK. Ahora hac√© approve.", 'ok');
        enableButtons(true, true, false, false);
      } catch (e) {
        log("Error: " + (e.message || e), 'err');
      }
    };

    // BUTTON: Approve (ERC20 approve to relayer)
    $("btn-approve").onclick = async () => {
      if (!prepared || !account) { alert("Falta preparar"); return; }
      try {
        const amount = toUint256(prepared.fee_aic_wei);
        const approveCall = {
          contractAddress: cfg.aic_token,
          entrypoint: "approve",
          calldata: [ cfg.relayer_address, amount.low, amount.high ]
        };

        const SAFE_MAX_FEE = "0x1DCD65000";
        const res = await account.execute([approveCall], undefined, {
          version: "0x3",
          maxFee: SAFE_MAX_FEE
        });

        const txHash = res.transaction_hash || res;
        log(`Approve enviado (v3 STRK)!\nTx: ${txHash}\nAhora firm√° el mensaje.`, "ok");
        enableButtons(true, true, true, false);
      } catch (e) {
        log(`Error approve: ${e.message || e}`, "err");
      }
    };

    // Sign message with fallbacks
    async function signTypedMessageWithFallback(accountObj, typed) {
      try {
        let sig = await accountObj.signMessage(typed);
        if (!Array.isArray(sig) && sig?.r && sig?.s) sig = [sig.r, sig.s];
        return sig;
      } catch (e) {
        console.warn("signMessage est√°ndar fall√≥, probando Braavos.request:", e);
      }

      const br = window.starknet_braavos || window.braavos;
      if (br?.request) {
        let sig = await br.request({
          type: "braavos_signMessage",
          params: typed,
        });
        if (!Array.isArray(sig) && sig?.r && sig?.s) sig = [sig.r, sig.s];
        return sig;
      }

      throw new Error("No se pudo firmar el mensaje (Braavos/ArgentX no disponible para firmar).");
    }

    // BUTTON: Sign
    $("btn-sign").onclick = async () => {
      if (!prepared || !account) { alert("Falta preparar"); return; }
      try {
        const typed = buildTypedData(
          prepared.alias_key,
          prepared.len,
          userAddr,
          prepared.nonce,
          cfg.chain_id
        );
        const sig = await signTypedMessageWithFallback(account, typed);
        prepared.signature = sig;
        log(`Firma OK\nR: ${sig[0]}\nS: ${sig[1]}`, "ok");
        enableButtons(true, true, true, true);
      } catch (e) {
        log(`Error firmando: ${e.message || e}`, "err");
        enableButtons(true, true, true, false);
      }
    };

    // BUTTON: Submit
    $("btn-submit").onclick = async () => {
      if (!prepared?.signature) { alert("Falta firmar"); return; }
      if (!API_BASE) { showError("Backend no configurado (API_BASE vac√≠o). No puedo enviar.", true); return; }

      try {
        log("Enviando al relayer...", 'info');

        const res = await fetch(`${API_BASE}/api/submit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_address: userAddr,
            alias: $("alias").value.trim(),
            signature: prepared.signature,
            nonce: prepared.nonce
          })
        });

        if (!res.ok) throw new Error(await res.text());
        const out = await res.json();

        log(`‚úÖ REGISTRO EXITOSO!\n\nTx: ${out.tx_hash}\nRelayer: ${out.relayer}\n\nPod√©s ver la tx en Starkscan/Voyager`, 'ok');

        prepared = null;
        $("prep").textContent = "";
        $("alias").value = "";
        enableButtons(true, false, false, false);
      } catch (e) {
        log(`Error: ${e.message}`, 'err');
      }
    };

    // Resolve helper buttons (use API_BASE)
    $("btn-resolve-alias").onclick = async () => {
      const alias = $("q-alias").value.trim();
      if (!alias) { alert("Ingres√° un alias"); return; }
      if (!API_BASE) { $("resolve-out").textContent = "Backend no configurado (API_BASE vac√≠o)."; return; }
      try {
        const r = await getJSON(`${API_BASE}/api/resolve_alias?alias=${encodeURIComponent(alias)}`);
        $("resolve-out").textContent = JSON.stringify(r, null, 2);
      } catch (e) {
        $("resolve-out").textContent = "Error: " + (e.message || e);
      }
    };

    $("btn-resolve-addr").onclick = async () => {
      const addr = $("q-addr").value.trim();
      if (!addr) { alert("Ingres√° un address 0x"); return; }
      if (!API_BASE) { $("resolve-out").textContent = "Backend no configurado (API_BASE vac√≠o)."; return; }
      try {
        const r = await getJSON(`${API_BASE}/api/resolve_address?address=${encodeURIComponent(addr)}`);
        $("resolve-out").textContent = JSON.stringify(r, null, 2);
      } catch (e) {
        $("resolve-out").textContent = "Error: " + (e.message || e);
      }
    };

    $("btn-list").onclick = async () => {
      if (!API_BASE) { $("resolve-out").textContent = "Backend no configurado (API_BASE vac√≠o)."; return; }
      try {
        const r = await getJSON(`${API_BASE}/list`);
        $("resolve-out").textContent = JSON.stringify(r, null, 2);
      } catch (e) {
        $("resolve-out").textContent = "Error: " + (e.message || e);
      }
    };

    // Initially disable buttons
    enableButtons(false, false, false, false);
  })();
  </script>
</body>
</html>
