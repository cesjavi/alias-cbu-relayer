<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Alias CBU – Gasless AIC</title>
  <style>
    :root {
      --bg-start: #eef2ff;
      --bg-end: #f7f7fb;
      --card-bg: #ffffff;
      --card-border: #d8def0;
      --primary: #3c6df0;
      --primary-hover: #345cd2;
      --accent: #00b894;
      --danger: #d7263d;
      --text-muted: #5e6472;
      --radius: 16px;
      --shadow: 0 20px 40px -25px rgba(42, 63, 119, 0.55);
      --transition: all 0.2s ease-in-out;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", "SF Pro Text", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 2.5rem 1.5rem 3rem;
      background: linear-gradient(160deg, var(--bg-start), var(--bg-end));
      color: #1f2430;
      display: flex;
      justify-content: center;
    }

    main {
      width: 100%;
      max-width: 880px;
    }

    h1 {
      font-size: clamp(1.9rem, 3vw, 2.6rem);
      margin-bottom: 0.35rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    h3 {
      font-size: 1.35rem;
      margin-top: 0;
      margin-bottom: 0.75rem;
      letter-spacing: -0.005em;
    }

    label {
      display: block;
      margin-top: 1.1rem;
      margin-bottom: 0.25rem;
      font-weight: 600;
      color: #2f3545;
    }

    input,
    button,
    select {
      font-size: 1rem;
      padding: 0.7rem 0.85rem;
      border-radius: 10px;
      border: 1px solid #ccd5f0;
      background: #fdfdff;
      transition: var(--transition);
    }

    input:focus,
    select:focus,
    button:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(60, 109, 240, 0.15);
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 14px 24px -18px rgba(60, 109, 240, 0.8);
      transition: var(--transition);
    }

    button.secondary {
      background: #f0f3ff;
      color: #1f2430;
      box-shadow: none;
    }

    button.secondary:hover:not(:disabled) {
      background: #e6ecff;
    }

    button.danger {
      background: var(--danger);
      box-shadow: 0 14px 28px -20px rgba(215, 38, 61, 0.9);
    }

    button.success {
      background: var(--accent);
      box-shadow: 0 14px 28px -20px rgba(0, 184, 148, 0.9);
    }

    button:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .row.tight {
      gap: 0.5rem;
    }

    .mono {
      font-family: ui-monospace, "SFMono-Regular", Menlo, monospace;
      font-size: 0.9em;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 1.4rem 1.6rem;
      margin-top: 1.25rem;
      box-shadow: var(--shadow);
    }

    .card.is-muted {
      background: #f7f9ff;
      border-color: rgba(60, 109, 240, 0.15);
      box-shadow: none;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.95rem;
      line-height: 1.55;
    }

    .steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.7rem;
      margin-top: 1rem;
    }

    .steps button {
      width: 100%;
      justify-content: center;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
    }

    .steps button span {
      display: inline-flex;
      width: 2rem;
      height: 2rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
      font-size: 0.85rem;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    pre {
      background: #0b1021;
      color: #d6e3ff;
      padding: 0.85rem 1rem;
      border-radius: 12px;
      overflow-x: auto;
      border: 1px solid #1d294a;
    }

    #wallet-ok {
      margin-top: 0.5rem;
      color: var(--accent);
      font-weight: 600;
    }

    #wallet-error {
      margin-top: 0.5rem;
      color: var(--danger);
      font-weight: 600;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(60, 109, 240, 0.12);
      color: #2b3c88;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      font-size: 0.85rem;
      margin-top: 0.75rem;
    }

    .badge-ok { background: rgba(0, 184, 148, 0.15); color: #006e58; }
    .badge-err { background: rgba(215, 38, 61, 0.12); color: #8d1122; }
    .badge-warn { background: rgba(255, 179, 0, 0.18); color: #8d5b00; }

    .alias-card {
      display: grid;
      gap: 1rem;
    }

    .alias-card .row {
      align-items: stretch;
    }

    .alias-card select {
      min-width: 210px;
    }

    .helper-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
    }

    .divider {
      height: 1px;
      background: #e4e7f5;
      margin: 1.5rem 0 1rem;
    }

    .card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .card-actions small {
      color: var(--text-muted);
    }

    @media (max-width: 720px) {
      body { padding: 2rem 1.25rem; }
      .card { padding: 1.25rem 1.2rem; }
      .row { gap: 0.6rem; }
      input,
      button,
      select { font-size: 0.97rem; }
    }
  </style>
</head>
<body>
  <main>
    <header class="card" style="margin-top:0;">
      <h1>Registrar alias (gasless, paga en AIC)</h1>
      <p class="muted">
        Seguí los pasos para completar el registro con una experiencia guiada.
      </p>
      <div class="status-badge">
        <span>✨</span> 1) Conectá wallet · 2) Prepará · 3) Approve · 4) Firmar · 5) Enviar
      </div>
      <div class="helper-text">Si el approve falla, probá con Firefox o actualizá la extensión.</div>
    </header>

    <section class="card alias-card">
      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label for="wallet-select">Elegí la wallet</label>
          <select id="wallet-select" style="width:100%;">
            <option value="auto">Detección automática</option>
            <option value="argentx">ArgentX Ready</option>
            <option value="braavos">Braavos</option>
            <option value="xverse">Xverse</option>
          </select>
          <div class="helper-text">Seleccioná el proveedor antes de conectar.</div>
        </div>
        <div class="row tight" style="flex:1; min-width:250px; align-self:flex-end;">
          <button id="btn-connect" style="flex:1;">
            <span>🔗</span>Conectar Wallet
          </button>
          <button id="btn-reset" type="button" class="secondary" style="flex:0 0 auto;">Reiniciar</button>
        </div>
      </div>
      <span id="acc" class="mono" style="font-size:0.95rem; color:#2b3c88;"></span>

      <div class="divider"></div>

      <div>
        <label for="alias">Alias (a-z 0-9 .) 4–20</label>
        <input id="alias" placeholder="mi.alias" style="width:100%; font-family: monospace;"/>
      </div>

      <div class="card is-muted">
        <strong>Direcciones externas (opcional)</strong>
        <p class="muted" style="margin-top:.5rem;">
          Se convierten a <code>felt</code>. Ingresá valores en hex <code>0x…</code> o texto ASCII (≤31 bytes).
        </p>
        <label for="eth-address" style="margin-top:.5rem;">ETH (0x…)</label>
        <input id="eth-address" placeholder="0x1234…" style="width:100%; font-family: monospace;"/>
        <label for="btc-address" style="margin-top:.5rem;">BTC / identificador</label>
        <input id="btc-address" placeholder="btc1… / hash" style="width:100%; font-family: monospace;"/>
      </div>

      <div class="steps">
        <button id="btn-prepare" disabled><span>1</span>Preparar</button>
        <button id="btn-approve" disabled><span>2</span>Approve AIC</button>
        <button id="btn-sign" disabled><span>3</span>Firmar</button>
        <button id="btn-submit" disabled class="success"><span>4</span>Enviar</button>
      </div>

      <div id="prep" class="mono" style="white-space:pre-wrap; margin-top:1rem; font-size: 0.85em;"></div>
      <div id="out" style="margin-top:1rem;"></div>
    </section>

    <section class="card">
      <div class="card-actions">
        <h3>Buscar / Resolver</h3>
        <small>Consultá el índice del relayer o la chain directamente.</small>
      </div>
      <div class="row">
        <input id="q-alias" placeholder="alias (p.ej. pepe.123)" style="flex:1; font-family:monospace;">
        <button id="btn-resolve-alias" class="secondary">Alias → Address</button>
      </div>
      <div class="row" style="margin-top:.5rem;">
        <input id="q-addr" placeholder="0x..." style="flex:1; font-family:monospace;">
        <button id="btn-resolve-addr" class="secondary">Address → Alias</button>
      </div>
      <div class="row" style="margin-top:.5rem;">
        <select id="chain-select" style="flex:0 0 160px;">
          <option value="ETH">ETH</option>
          <option value="BTC">BTC</option>
        </select>
        <input id="external-address" placeholder="externo (0x… o ASCII)" style="flex:1; font-family:monospace;">
        <button id="btn-resolve-external" class="secondary">Ext → Alias</button>
      </div>
      <div class="row" style="margin-top:.5rem;">
        <button id="btn-list" class="secondary">Listar (índice local del relayer)</button>
        <button id="btn-list-contract" class="secondary">Listar on-chain (AliasExternalUpdated)</button>
      </div>
      <div class="row" style="margin-top:.5rem;">
        <button id="btn-faucet" class="success">🚰 Faucet AIC</button>
      </div>

      <pre id="resolve-out" class="mono" style="margin-top: .75rem;"></pre>
    </section>

    <div id="wallet-ok"></div>
    <div id="wallet-error"></div>
  </main>

  <!-- API_BASE vacío = MISMO dominio (Vercel sirve app.py en /api/*) -->
  <script>
    const API_BASE = ""; 
    const apiUrl = (path) => {
      const base = API_BASE ? API_BASE.replace(/\/$/, "") : "";
      return `${base}${path}`;
    };
  </script>

  <script>
  (function () {
    const $ = id => document.getElementById(id);
    const okEl = $("wallet-ok");
    const errEl = $("wallet-error");
    const ethInputEl = $("eth-address");
    const btcInputEl = $("btc-address");
    const chainSelect = $("chain-select");
    const walletSelect = $("wallet-select");
    const externalAddressInput = $("external-address");

    function shortHex(h){ if(!h) return ""; const s=h.replace(/^0x/,""); return "0x"+s.slice(0,6)+"…"+s.slice(-6); }
    function showError(msg){ console.error(msg); errEl && (errEl.textContent = msg); alert(msg); }
    function log(m, type = 'info') {
      const icons = { info: 'ℹ️', ok: '✅', err: '❌', warn: '⚠️' };
      const classes = { info: '', ok: 'ok', err: 'err', warn: 'warn' };
      console.log("[aliascbu]", m);
      $("out").innerHTML = `<span class="${classes[type]}">${icons[type]} ${
        typeof m === "string" ? m.replace(/\n/g, '<br/>') : JSON.stringify(m, null, 2)
      }</span>`;
    }

    // ===== Utils Cairo/hex =====
    const FIELD_P = (2n ** 251n) + (17n * (2n ** 192n)) + 1n;
    const strip0x = (h) => (h || "").toLowerCase().replace(/^0x/, "");
    const padHex64 = (h) => "0x" + strip0x(h).padStart(64, "0");
    const toFeltHex = (hex) => {
      let n = BigInt("0x" + strip0x(hex));
      n = ((n % FIELD_P) + FIELD_P) % FIELD_P;
      return "0x" + n.toString(16);
    };
    const toUint256 = (value) => {
      const bn = BigInt(value);
      return {
        low: "0x" + (bn & ((1n << 128n) - 1n)).toString(16),
        high: "0x" + (bn >> 128n).toString(16)
      };
    };

    function buildTypedData(alias_key_hex, len, user_hex, nonce, chainId_hex, eth_felt, btc_felt) {
      const cleanHex = (h) => {
        const s = strip0x(h);
        return "0x" + (s.replace(/^0+/, "") || "0");
      };
      return {
        types: {
          StarkNetDomain: [
            { name: "name", type: "felt" },
            { name: "version", type: "felt" },
            { name: "chainId", type: "felt" },
          ],
          RegisterAlias: [
            { name: "user_addr", type: "felt" },
            { name: "alias_key", type: "felt" },
            { name: "len", type: "felt" },
            { name: "nonce", type: "felt" },
            { name: "eth_address", type: "felt" },
            { name: "btc_address", type: "felt" },
          ],
        },
        primaryType: "RegisterAlias",
        domain: {
          name: "AliasCBU",
          version: "1",
          chainId: cleanHex(chainId_hex),
        },
        message: {
          user_addr: toFeltHex(user_hex),
          alias_key: toFeltHex(alias_key_hex),
          len: String(len),
          nonce: String(nonce),
          eth_address: toFeltHex(eth_felt || "0x0"),
          btc_address: toFeltHex(btc_felt || "0x0"),
        },
      };
    }

    function detectXverse() {
      const guesses = [];
      if (window.starknet_xverse) guesses.push(window.starknet_xverse);
      const providers = window.xverseProviders;
      if (providers?.starknet) guesses.push(providers.starknet);
      if (window.xverse) {
        if (window.xverse.starknet) guesses.push(window.xverse.starknet);
        if (window.xverse.starknetProvider) guesses.push(window.xverse.starknetProvider);
      }
      if (window.xverseProvider) guesses.push(window.xverseProvider);
      if (window.xverseWallet?.starknet) guesses.push(window.xverseWallet.starknet);
      if (window.btc?.starknet) guesses.push(window.btc.starknet);
      for (const guess of guesses) {
        if (!guess) continue;
        if (typeof guess === "function") {
          try {
            const maybe = guess();
            if (maybe) return maybe;
          } catch (e) {}
        }
        if (typeof guess.getProvider === "function") {
          try {
            const provider = guess.getProvider();
            if (provider) return provider;
          } catch (e) {}
        }
        if (guess?.provider) return guess.provider;
        if (guess?.request || guess?.enable || guess?.account || guess?.selectedAddress || guess?.selectedAccount) {
          return guess;
        }
      }
      return null;
    }

    function waitForWallets(ms = 8000) {
      return new Promise((resolve) => {
        const kick = () => {
          const sn = window.starknet || null;
          const argentx = (sn && sn.isArgentX) ? sn : (window.starknet_argentX || null);
          const braavos = (sn && sn.isBraavos) ? sn : (window.starknet_braavos || window.braavos || null);
          const xverse = detectXverse();
          resolve({ braavos, argentx, xverse });
        };
        if (window.starknet || window.starknet_braavos || window.braavos || window.starknet_argentX || window.starknet_xverse || window.xverseProviders || window.xverse || window.xverseProvider || window.xverseWallet) return kick();
        const handler = () => kick();
        window.addEventListener('starknet#initialized', handler, { once: true });
        window.addEventListener('xverse#initialized', handler, { once: true });
        setTimeout(kick, ms);
      });
    }

    const FRIENDLY_WALLET_NAME = {
      auto: "detección automática",
      argentx: "ArgentX Ready",
      braavos: "Braavos",
      xverse: "Xverse",
    };

    async function connectDirect(preference = "auto") {
      const { braavos, argentx, xverse } = await waitForWallets(8000);
      const normalized = (preference || "auto").toLowerCase();
      const braavosLegacy = window.braavos;
      const candidates = [
        { name: 'ArgentX', id: 'argentx', obj: argentx },
        { name: 'Braavos', id: 'braavos', obj: braavos },
        { name: 'Xverse', id: 'xverse', obj: xverse },
        { name: 'Braavos (legacy)', id: 'braavos', obj: braavosLegacy }
      ];
      const preferredCandidates = normalized === 'auto'
        ? candidates
        : candidates.filter(c => c.id === normalized);
      if (normalized !== 'auto' && preferredCandidates.length === 0) {
        const label = FRIENDLY_WALLET_NAME[normalized] || preference;
        throw new Error(`No se detectó ${label}. Revisá la extensión y recargá.`);
      }
      const pool = normalized === 'auto' ? candidates : preferredCandidates;
      let lastError = null;
      for (const { name, obj } of pool) {
        if (!obj) continue;
        try {
          if (typeof obj.enable === 'function') await obj.enable({ starknetVersion: 'v5' });
          else if (obj.request) await obj.request({ type: 'wallet_requestAccounts' });
          const acc = obj.account || obj.selectedAccount || obj;
          if (acc?.address) return { account: acc, address: acc.address, name };
          if (obj.selectedAddress) return { account: obj, address: obj.selectedAddress, name };
        } catch (e) {
          lastError = e;
          console.warn(`${name} falló:`, e?.message || e);
        }
      }
      if (normalized !== 'auto') {
        const label = FRIENDLY_WALLET_NAME[normalized] || preference;
        if (lastError) {
          throw new Error(`No se pudo conectar con ${label}: ${lastError.message || lastError}.`);
        }
        throw new Error(`No se detectó ${label}. Revisá la extensión y recargá.`);
      }
      if (lastError) {
        throw new Error(`No se pudo conectar con ninguna wallet disponible (${lastError.message || lastError}).`);
      }
      throw new Error("No se encontró ArgentX, Braavos ni Xverse. Revisá 'Site access' en la extensión y recargá.");
    }

    let account = null, userAddr = null, prepared = null, cfg = null, walletName = null;

    function enableButtons(p, a, s, su) {
      $("btn-prepare").disabled = !p;
      $("btn-approve").disabled = !a;
      $("btn-sign").disabled = !s;
      $("btn-submit").disabled = !su;
    }

    async function getJSON(url) {
      const r = await fetch(url);
      const t = await r.text();
      let d = null;
      try { d = t ? JSON.parse(t) : null; } catch {}
      if (!r.ok) throw new Error(d?.detail || d?.error || t || `HTTP ${r.status}`);
      return d ?? {};
    }

    $("btn-connect").onclick = async () => {
      try {
        const pref = walletSelect ? walletSelect.value : "auto";
        const label = FRIENDLY_WALLET_NAME[pref] || pref;
        log(`Conectando wallet (${label})...`);
        const conn = await connectDirect(pref);
        account = conn.account;
        userAddr = padHex64(conn.address);
        walletName = conn.name;
        $("acc").textContent = `${userAddr.slice(0,10)}...${userAddr.slice(-8)} (${conn.name})`;

        log("Obteniendo configuración desde backend...", "info");
        const res = await fetch(apiUrl("/api/config"));
        if (!res.ok) throw new Error(await res.text());
        cfg = await res.json();

        cfg.external_chain_ids = cfg.external_chain_ids || {};
        cfg.aic_token = padHex64(cfg.aic_token);
        cfg.relayer_address = padHex64(cfg.relayer_address);
        cfg.chain_id = "0x" + strip0x(cfg.chain_id).replace(/^0+/, '');
        if (chainSelect) {
          chainSelect.innerHTML = "";
          const entries = Object.entries(cfg.external_chain_ids);
          if (!entries.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "Sin cadenas";
            chainSelect.appendChild(opt);
            chainSelect.disabled = true;
          } else {
            chainSelect.disabled = false;
            for (const [label, felt] of entries) {
              const opt = document.createElement("option");
              opt.value = label;
              opt.textContent = `${label} (${felt})`;
              chainSelect.appendChild(opt);
            }
          }
        }

        const chainLabels = Object.keys(cfg.external_chain_ids);
        log(`Conectado: ${conn.name}\nChainId: ${cfg.chain_id}\nChains externas: ${chainLabels.length ? chainLabels.join(', ') : 'ninguna'}`, 'ok');
        okEl && (okEl.textContent = `Conectado: ${shortHex(userAddr)} (${conn.name})`);
        enableButtons(true, false, false, false);
      } catch (e) {
        log(`Error: ${e.message}\n\nProbá:\n• Recargar (Ctrl+Shift+R)\n• Usar Firefox\n• Actualizar extensión`, 'err');
        showError(e.message);
      }
    };

    $("btn-reset").onclick = () => {
      account = userAddr = prepared = cfg = null;
      walletName = null;
      $("acc").textContent = "";
      $("prep").textContent = "";
      $("resolve-out").textContent = "";
      $("out").innerHTML = "";
      okEl && (okEl.textContent = "");
      errEl && (errEl.textContent = "");
      ethInputEl && (ethInputEl.value = "");
      btcInputEl && (btcInputEl.value = "");
      externalAddressInput && (externalAddressInput.value = "");
      if (walletSelect) {
        walletSelect.value = "auto";
      }
      if (chainSelect && chainSelect.options.length) {
        chainSelect.selectedIndex = 0;
      }
      enableButtons(false, false, false, false);
      log("Reset OK");
    };

    $("btn-prepare").onclick = async () => {
      if (!userAddr) { alert("Conectá wallet"); return; }
      const alias = $("alias").value.trim();
      if (!alias) { alert("Ingresá un alias"); return; }
      const ethRaw = ethInputEl ? ethInputEl.value.trim() : "";
      const btcRaw = btcInputEl ? btcInputEl.value.trim() : "";

      try {
        const res = await fetch(apiUrl("/api/prepare"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_address: userAddr,
            alias,
            eth_address: ethRaw || null,
            btc_address: btcRaw || null,
          })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        prepared = {
          ...data,
          alias_input: alias,
          eth_input: ethRaw,
          btc_input: btcRaw,
        };
        const lines = [
          `✓ Alias: ${alias}`,
          `  Key: ${prepared.alias_key}`,
          `  Fee: ${prepared.fee_aic_wei} wei`,
        ];
        if (prepared.eth_address_felt && prepared.eth_address_felt !== "0x0") {
          const extra = prepared.eth_address_ascii ? ` (ascii: ${prepared.eth_address_ascii})` : "";
          lines.push(`  ETH felt: ${prepared.eth_address_felt}${extra}`);
        }
        if (prepared.btc_address_felt && prepared.btc_address_felt !== "0x0") {
          const extra = prepared.btc_address_ascii ? ` (ascii: ${prepared.btc_address_ascii})` : "";
          lines.push(`  BTC felt: ${prepared.btc_address_felt}${extra}`);
        }
        $("prep").textContent = lines.join("\n");
        log("Preparado OK. Ahora hacé approve.", 'ok');
        enableButtons(true, true, false, false);
      } catch (e) {
        log("Error: " + (e.message || e), 'err');
      }
    };

    $("btn-approve").onclick = async () => {
      if (!prepared || !account) { alert("Falta preparar"); return; }
      try {
        const amount = toUint256(prepared.fee_aic_wei);
        const approveCall = {
          contractAddress: cfg.aic_token,
          entrypoint: "approve",
          calldata: [ cfg.relayer_address, amount.low, amount.high ]
        };
        const SAFE_MAX_FEE = "0x1DCD65000";
        const res = await account.execute([approveCall], undefined, {
          version: "0x3",
          maxFee: SAFE_MAX_FEE
        });
        const txHash = res.transaction_hash || res;
        log(`Approve enviado (v3 STRK)!\nTx: ${txHash}\nAhora firmá el mensaje.`, "ok");
        enableButtons(true, true, true, false);
      } catch (e) {
        log(`Error approve: ${e.message || e}`, "err");
      }
    };

    async function signTypedMessageWithFallback(accountObj, typed) {
      try {
        let sig = await accountObj.signMessage(typed);
        if (!Array.isArray(sig) && sig?.r && sig?.s) sig = [sig.r, sig.s];
        return sig;
      } catch (e) {
        console.warn("signMessage estándar falló, probando request directa:", e);
      }
      if (walletName === 'Xverse') {
        const xverse = detectXverse();
        if (xverse?.request) {
          const payloads = [
            { type: "wallet_signTypedData", params: typed },
            { type: "wallet_signTypedData", params: [typed] },
            { type: "wallet_signMessage", params: typed },
            { type: "wallet_signMessage", params: [typed] },
          ];
          for (const payload of payloads) {
            try {
              let sig = await xverse.request(payload);
              if (sig?.result) sig = sig.result;
              if (!sig) continue;
              if (!Array.isArray(sig) && sig?.r && sig?.s) sig = [sig.r, sig.s];
              if (Array.isArray(sig)) return sig;
            } catch (_) {}
          }
        }
      }
      const br = window.starknet_braavos || window.braavos;
      if (br?.request) {
        let sig = await br.request({ type: "braavos_signMessage", params: typed });
        if (!Array.isArray(sig) && sig?.r && sig?.s) sig = [sig.r, sig.s];
        return sig;
      }
      throw new Error("No se pudo firmar el mensaje (wallet no respondió).");
    }

    $("btn-sign").onclick = async () => {
      if (!prepared || !account) { alert("Falta preparar"); return; }
      try {
        const typed = buildTypedData(
          prepared.alias_key,
          prepared.len,
          userAddr,
          prepared.nonce,
          cfg.chain_id,
          prepared.eth_address_felt,
          prepared.btc_address_felt
        );
        const sig = await signTypedMessageWithFallback(account, typed);
        prepared.signature = sig;
        log(`Firma OK\nR: ${sig[0]}\nS: ${sig[1]}`, "ok");
        enableButtons(true, true, true, true);
      } catch (e) {
        log(`Error firmando: ${e.message || e}`, "err");
        enableButtons(true, true, true, false);
      }
    };

    $("btn-submit").onclick = async () => {
      if (!prepared?.signature) { alert("Falta firmar"); return; }
      try {
        log("Enviando al relayer...", 'info');
        const res = await fetch(apiUrl("/api/submit"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_address: userAddr,
            alias: prepared.alias_input || $("alias").value.trim(),
            signature: prepared.signature,
            nonce: prepared.nonce,
            eth_address: prepared.eth_address_felt,
            btc_address: prepared.btc_address_felt,
          })
        });
        if (!res.ok) throw new Error(await res.text());
        const out = await res.json();
        log(`✅ REGISTRO EXITOSO!\n\nTx: ${out.tx_hash}\nRelayer: ${out.relayer}`, 'ok');
        prepared = null;
        $("prep").textContent = "";
        $("alias").value = "";
        ethInputEl && (ethInputEl.value = "");
        btcInputEl && (btcInputEl.value = "");
        enableButtons(true, false, false, false);
      } catch (e) {
        log(`Error: ${e.message}`, 'err');
      }
    };

    $("btn-resolve-alias").onclick = async () => {
      const alias = $("q-alias").value.trim();
      if (!alias) { alert("Ingresá un alias"); return; }
      try {
        const r = await getJSON(apiUrl(`/api/resolve_alias?alias=${encodeURIComponent(alias)}`));
        $("resolve-out").textContent = JSON.stringify(r, null, 2);
      } catch (e) {
        $("resolve-out").textContent = "Error: " + (e.message || e);
      }
    };

    $("btn-resolve-addr").onclick = async () => {
      const addr = $("q-addr").value.trim();
      if (!addr) { alert("Ingresá un address 0x"); return; }
      try {
        const r = await getJSON(apiUrl(`/api/resolve_address?address=${encodeURIComponent(addr)}`));
        $("resolve-out").textContent = JSON.stringify(r, null, 2);
      } catch (e) {
        $("resolve-out").textContent = "Error: " + (e.message || e);
      }
    };

    $("btn-resolve-external").onclick = async () => {
      const chain = chainSelect ? chainSelect.value : "";
      const ext = externalAddressInput ? externalAddressInput.value.trim() : "";
      if (!chain) { alert("Elegí una red externa"); return; }
      if (!ext) { alert("Ingresá una dirección externa"); return; }
      try {
        const r = await getJSON(apiUrl(`/api/alias_of_external?chain=${encodeURIComponent(chain)}&external_address=${encodeURIComponent(ext)}`));
        $("resolve-out").textContent = JSON.stringify(r, null, 2);
      } catch (e) {
        $("resolve-out").textContent = "Error: " + (e.message || e);
      }
    };

    $("btn-list").onclick = async () => {
      try {
        const r = await getJSON(apiUrl("/api/list"));
        $("resolve-out").textContent = JSON.stringify(r, null, 2);
      } catch (e) {
        $("resolve-out").textContent = "Error: " + (e.message || e);
      }
    };

    $("btn-list-contract").onclick = async () => {
      try {
        const limitRaw = prompt("Cantidad de eventos a leer (1-100, vacío = 20)", "");
        const params = [];
        if (limitRaw && limitRaw.trim()) {
          const parsed = Number.parseInt(limitRaw, 10);
          if (!Number.isNaN(parsed)) {
            const safe = Math.max(1, Math.min(parsed, 100));
            params.push(`limit=${safe}`);
          }
        }
        const tokenRaw = prompt("continuation_token (opcional)", "");
        if (tokenRaw && tokenRaw.trim()) {
          params.push(`continuation_token=${encodeURIComponent(tokenRaw.trim())}`);
        }
        const maxChunksRaw = prompt("Máx. páginas a recorrer (1-1000, vacío = 200)", "");
        if (maxChunksRaw && maxChunksRaw.trim()) {
          const parsedChunks = Number.parseInt(maxChunksRaw, 10);
          if (!Number.isNaN(parsedChunks)) {
            const safeChunks = Math.max(1, Math.min(parsedChunks, 1000));
            params.push(`max_chunks=${safeChunks}`);
          }
        }
        const qs = params.length ? `?${params.join("&")}` : "";
        const r = await getJSON(apiUrl(`/api/contract_events${qs}`));
        $("resolve-out").textContent = JSON.stringify(r, null, 2);
      } catch (e) {
        $("resolve-out").textContent = "Error: " + (e.message || e);
      }
    };

    $("btn-faucet").onclick = async () => {
  try {
    if (!userAddr) {
      alert("Conectá la wallet primero");
      return;
    }
    const res = await fetch("/api/faucet", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ address: userAddr })
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    log(`✅ Faucet enviado!\nTx: ${data.tx_hash}\nTo: ${data.to}\nAmount: 10 AIC`, "ok");
  } catch (e) {
    log("Error faucet: " + (e.message || e), "err");
  }
};


    enableButtons(false, false, false, false);
  })();
  </script>
</body>
</html>
